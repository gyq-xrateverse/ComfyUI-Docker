# ComfyUI-Docker 项目打包原理

本文档旨在阐述 `ComfyUI-Docker` 项目的依赖管理和打包机制。

## 核心机制

项目采用一个统一的Python脚本 `scripts/build_dependencies.py` 来自动化管理整个Python环境的依赖项。这个脚本取代了传统的手动管理多个 `requirements.txt` 文件的方式，提供了一个集中化、可控的解决方案。

其核心工作流如下：

1.  **依赖发现**: 脚本启动时，会递归扫描项目中的两个核心位置：
    *   项目根目录 (`/app`)
    *   所有自定义节点目录 (`/app/custom_nodes`)
    它会查找所有命名为 `requirements.txt` 或 `requirements*.txt` 的文件，并收集其中声明的所有Python包。

2.  **版本冲突解决**: 在收集完所有依赖后，脚本会采用一套预设的策略来解决版本冲突：
    *   **强制固定版本**: 脚本内部维护一个 `PINNED_PACKAGES` 列表，包含像 `torch`, `torchvision`, `numpy` 等核心库。这些库的版本被强制固定，会覆盖任何 `requirements.txt` 文件中的声明，以确保核心环境的稳定性。
    *   **最高版本优先**: 如果多个自定义节点对同一个依赖包指定了不同的精确版本（例如 `package==1.0` 和 `package==1.1`），脚本会自动选择**最高**的版本进行安装，并打印警告信息。
    *   **特殊处理**: 脚本对某些特定的库（如 `OpenCV`）有特殊处理逻辑。它会自动将所有 `opencv-*` 的变体统一替换为 `opencv-contrib-python-headless`，以避免在无头环境中出现冲突。

3.  **手动包注入**: 脚本提供了一个 `MANUAL_PACKAGES` 列表。**这是指定额外依赖项的关键位置**。在此列表中添加的包名，会在所有其他依赖安装完成后被自动安装。这对于以下场景非常有用：
    *   某些依赖没有在任何 `requirements.txt` 中声明。
    *   需要安装一些基础工具或调试库。
    *   解决一些复杂的、通过常规依赖解决器难以处理的依赖问题。

4.  **安装执行**:
    *   脚本会首先安装所有经过版本解决后的依赖。
    *   对于 `torch` 相关的库，它会使用特定的PyTorch官方下载源 (`--index-url`) 以确保下载正确的、与CUDA兼容的版本。
    *   最后，安装 `MANUAL_PACKAGES` 列表中的所有包。

5.  **生成最终清单**: 所有操作完成后，脚本会将最终确定的、包含精确版本号的完整依赖列表写入项目根目录下的 `final_requirements.txt` 文件。这个文件是对当前构建环境的一个快照，可用于调试和复现。

## 如何指定额外安装的包？

是的，`MANUAL_PACKAGES` 列表中的所有包都会在构建过程中被**自动安装**。

要添加一个在标准流程中未被包含的Python包，您需要编辑 `scripts/build_dependencies.py` 文件。

找到 `MANUAL_PACKAGES` 列表（大约在第39行），并将您需要添加的包（字符串格式）添加到该列表中。这个列表支持所有 `pip install` 命令接受的格式，包括包名、本地路径以及来自版本控制系统的URL。

### 示例 1：添加一个标准的PyPI包

如果您需要安装 `my-custom-package`，您可以这样修改：
```python
# scripts/build_dependencies.py
MANUAL_PACKAGES = [
    # ... 其他包
    "my-custom-package"
]
```

### 示例 2：添加一个来自Git仓库的包

如果您需要从 Git 安装特定版本的包（例如 `diffusers`），您可以直接将 `git+` 链接作为字符串添加进去：
```python
# scripts/build_dependencies.py
MANUAL_PACKAGES = [
    # ... 其他包
    "git+https://github.com/huggingface/diffusers"
]
```

修改完毕后，当构建流程（例如，Docker镜像构建）再次运行时，这个额外的包就会被自动安装。您也可以通过设置环境变量 `REGENERATE_REQUIREMENTS=true` 来在容器启动时强制触发此脚本的执行。